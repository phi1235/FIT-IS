<div class="user-management-container">
    <div class="page-header">
        <h1>üë• Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h1>
        <div class="header-actions">
            <div class="export-buttons">
                <button class="btn-export pdf" (click)="downloadReport('pdf')" [disabled]="exporting" title="Xu·∫•t PDF">
                    PDF
                </button>
                <button class="btn-export excel" (click)="downloadReport('xlsx')" [disabled]="exporting"
                    title="Xu·∫•t Excel">
                    Excel
                </button>
            </div>
            <button class="btn-refresh" (click)="loadUsers()" [disabled]="loading">
                L√†m m·ªõi
            </button>
        </div>
    </div>

    <!-- Search Box -->
    <div class="search-box">
        <input type="text" placeholder=" T√¨m ki·∫øm theo username, email..." [value]="searchQuery"
            (input)="onSearch($event)" class="search-input" />
        <span class="search-info">T·ªïng: {{ totalElements }} users</span>
    </div>

    <!-- Export Message with Progress Bar -->
    <div *ngIf="exportMessage" class="export-message" [class.exporting]="exporting">
        <div class="export-text">{{ exportMessage }}</div>
        <div *ngIf="exporting && exportProgress > 0" class="progress-bar-container">
            <div class="progress-bar" [style.width.%]="exportProgress"></div>
        </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="error-message">
        {{ error }}
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading">
        <div class="spinner"></div>
        <span>ƒêang t·∫£i...</span>
    </div>

    <!-- Users Table -->
    <div *ngIf="!loading" class="table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>H·ªç T√™n</th>
                    <th>Role</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let user of users" [class.disabled]="!user.enabled">
                    <td><strong>{{ user.username }}</strong></td>
                    <td>{{ user.email }}</td>
                    <td>{{ (user.firstName || '') + ' ' + (user.lastName || '') }}</td>
                    <td>
                        <span class="badge" [class.badge-admin]="user.role === 'admin'"
                            [class.badge-user]="user.role === 'user'">
                            {{ user.role === 'admin' ? ' Admin' : ' User' }}
                        </span>
                    </td>
                    <td>
                        <span class="status" [class.status-active]="user.enabled"
                            [class.status-inactive]="!user.enabled">
                            {{ user.enabled ? 'Ho·∫°t ƒë·ªông' : ' V√¥ hi·ªáu h√≥a' }}
                        </span>
                    </td>
                    <td>
                        <button class="btn-action" (click)="openRoleModal(user)">ƒê·ªïi Role</button>
                    </td>
                </tr>
                <tr *ngIf="users.length === 0">
                    <td colspan="6" class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                </tr>
            </tbody>
        </table>

        <!-- Pagination Controls -->
        <div class="pagination-controls" *ngIf="totalPages > 0">
            <div class="pagination-info">
                Hi·ªÉn th·ªã {{ currentPage * pageSize + 1 }} - {{ (currentPage + 1) * pageSize > totalElements ?
                totalElements : (currentPage + 1) * pageSize }}
                trong t·ªïng s·ªë {{ totalElements }} users
            </div>

            <div class="pagination-nav">
                <button class="btn-page" (click)="goToPage(0)" [disabled]="currentPage === 0"
                    title="Trang ƒë·∫ßu">‚èÆ</button>
                <button class="btn-page" (click)="previousPage()" [disabled]="currentPage === 0"
                    title="Trang tr∆∞·ªõc">‚óÄ</button>

                <button *ngFor="let page of getPageNumbers()" class="btn-page" [class.active]="page === currentPage"
                    (click)="goToPage(page)">
                    {{ page + 1 }}
                </button>

                <button class="btn-page" (click)="nextPage()" [disabled]="currentPage >= totalPages - 1"
                    title="Trang sau">‚ñ∂</button>
                <button class="btn-page" (click)="goToPage(totalPages - 1)" [disabled]="currentPage >= totalPages - 1"
                    title="Trang cu·ªëi">‚è≠</button>
            </div>

            <div class="page-size-selector">
                <label>Hi·ªÉn th·ªã:</label>
                <select [value]="pageSize" (change)="onPageSizeChange($event)">
                    <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
                </select>
                <span>/ trang</span>
            </div>
        </div>
    </div>

    <!-- Role Update Modal -->
    <div *ngIf="showRoleModal" class="modal-overlay" (click)="closeRoleModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>ƒê·ªïi Role cho User</h3>
                <button class="btn-close" (click)="closeRoleModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" [value]="selectedUser?.username" readonly class="form-control">
                </div>
                <div class="form-group">
                    <label>Role m·ªõi:</label>
                    <select [(ngModel)]="newRole" class="form-control">
                        <option value="user"> User</option>
                        <option value="maker">Maker</option>
                        <option value="checker"> Checker</option>
                        <option value="admin"> Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" (click)="closeRoleModal()">H·ªßy</button>
                <button class="btn-save" (click)="updateUserRole()" [disabled]="loading">
                    {{ loading ? 'ƒêang l∆∞u...' : 'L∆∞u' }}
                </button>
            </div>
        </div>
    </div>
</div>